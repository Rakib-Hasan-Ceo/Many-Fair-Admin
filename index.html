<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>অ্যাডমিন প্যানেল - Money Fair</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: 'Hind Siliguri', sans-serif; background-color: #f3f4f6; }
        .sidebar-active { background: linear-gradient(90deg, #4f46e5, #4338ca); border-right: 3px solid #fbbf24; }
        .sidebar-closed { transform: translateX(-100%); }
        #sidebar { transition: transform 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <!-- Login Overlay -->
    <div id="admin-login-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/95 backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm">
            <div class="text-center mb-6">
                <i class="fa-solid fa-user-shield text-5xl text-blue-600 mb-2"></i>
                <h2 class="text-2xl font-bold text-gray-800">অ্যাডমিন লগিন</h2>
            </div>
            <div class="space-y-4">
                <input type="email" id="admin-email" placeholder="ইমেইল" class="w-full p-3 border rounded-lg outline-none">
                <input type="password" id="admin-pass" placeholder="পাসওয়ার্ড" class="w-full p-3 border rounded-lg outline-none">
                <button onclick="adminLogin()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700">লগিন</button>
            </div>
        </div>
    </div>

    <!-- Dashboard Wrapper -->
    <div id="admin-wrapper" class="hidden flex h-screen overflow-hidden relative">
        <aside id="sidebar" class="sidebar-closed absolute md:relative md:translate-x-0 w-64 bg-slate-900 text-white flex-shrink-0 flex flex-col shadow-2xl z-30 h-full">
            <div class="p-6 flex items-center justify-between border-b border-slate-800">
                <div class="flex items-center gap-3"><i class="fa-solid fa-shield-cat text-3xl text-yellow-400"></i><h1 class="text-2xl font-bold">অ্যাডমিন</h1></div>
                <button class="md:hidden text-gray-400" onclick="toggleSidebar()"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <nav class="mt-6 flex-grow space-y-2 px-4 overflow-y-auto">
                <a href="#" class="nav-link sidebar-active flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 transition" onclick="showSection('dashboard', this)"><i class="fa-solid fa-chart-line"></i> ড্যাশবোর্ড</a>
                <a href="#" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 transition text-slate-400" onclick="showSection('users', this)"><i class="fa-solid fa-users"></i> ইউজার লিস্ট</a>
                <a href="#" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 transition text-slate-400" onclick="showSection('tasks', this)"><i class="fa-solid fa-list-check"></i> টাস্ক ও নোটিশ</a>
                <a href="#" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 transition text-slate-400" onclick="showSection('withdrawals', this)"><i class="fa-solid fa-money-bill-transfer"></i> পেমেন্ট</a>
                <a href="#" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 transition text-slate-400" onclick="showSection('settings', this)"><i class="fa-solid fa-gears"></i> সেটিংস</a>
                <button onclick="adminLogout()" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-red-600/20 text-red-400 mt-10"><i class="fa-solid fa-power-off"></i> লগআউট</button>
            </nav>
        </aside>

        <div class="flex-1 flex flex-col h-screen overflow-hidden">
            <header class="bg-white shadow-sm p-4 flex justify-between items-center z-10">
                <button onclick="toggleSidebar()" class="md:hidden text-slate-800 text-2xl"><i class="fa-solid fa-bars"></i></button>
                <h2 class="text-xl font-bold text-slate-700">কন্ট্রোল প্যানেল</h2>
            </header>

            <main class="flex-1 overflow-y-auto p-4 md:p-6">
                <!-- Dashboard -->
                <div id="dashboard-section" class="section block">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-blue-600 p-6 rounded-2xl shadow-lg text-white">
                            <h3 class="opacity-90">মোট ইউজার</h3>
                            <p class="text-4xl font-bold mt-2" id="stat-total-users">Loading...</p>
                        </div>
                        <div class="bg-purple-600 p-6 rounded-2xl shadow-lg text-white">
                            <h3 class="opacity-90">পেন্ডিং পেমেন্ট</h3>
                            <p class="text-4xl font-bold mt-2" id="stat-pending-withdraw">Loading...</p>
                        </div>
                    </div>
                </div>

                <!-- User List -->
                <div id="users-section" class="section hidden">
                    <div class="bg-white rounded-2xl shadow-sm border overflow-hidden">
                        <div class="p-5 border-b bg-gray-50 flex justify-between items-center">
                            <h3 class="font-bold text-gray-700">সকল ইউজার</h3>
                            <span class="text-xs text-gray-500">Last 50 users</span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-gray-100 uppercase font-bold text-gray-600">
                                    <tr><th class="p-4">নাম</th><th class="p-4">ইমেইল</th><th class="p-4">রেফার কোড</th><th class="p-4">ব্যালেন্স</th></tr>
                                </thead>
                                <tbody id="users-table-body" class="divide-y"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Task Control -->
                <div id="tasks-section" class="section hidden space-y-6">
                    <!-- Notice Board -->
                    <div class="bg-white p-6 rounded-2xl shadow-sm border">
                        <h3 class="text-xl font-bold mb-4 border-b pb-2 flex items-center gap-2"><i class="fa-solid fa-bullhorn text-orange-500"></i> মেইন নোটিশ বোর্ড</h3>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="notice-text" placeholder="নোটিশ লিখুন..." class="flex-1 p-2 border rounded">
                            <button onclick="addNotice()" class="bg-orange-600 text-white px-4 py-2 rounded font-bold">যোগ করুন</button>
                        </div>
                        <ul id="notice-list" class="space-y-2"></ul>
                    </div>

                    <!-- Instructions Section -->
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-blue-200">
                        <h3 class="text-xl font-bold mb-4 border-b pb-2 flex items-center gap-2"><i class="fa-solid fa-circle-info text-blue-500"></i> টাস্ক ও উইথড্র নিয়মাবলী</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="text-sm font-bold text-gray-600">সোশ্যাল টাস্ক নিয়ম</label><textarea id="inst-social" rows="2" class="w-full p-2 border rounded mt-1 bg-gray-50"></textarea></div>
                            <div><label class="text-sm font-bold text-gray-600">উইথড্র নিয়ম</label><textarea id="inst-withdraw" rows="2" class="w-full p-2 border rounded mt-1 bg-gray-50"></textarea></div>
                            <div><label class="text-sm font-bold text-gray-600">ভিডিও অ্যাড নিয়ম</label><textarea id="inst-video" rows="2" class="w-full p-2 border rounded mt-1 bg-gray-50"></textarea></div>
                            <div><label class="text-sm font-bold text-gray-600">স্পিন নিয়ম</label><textarea id="inst-spin" rows="2" class="w-full p-2 border rounded mt-1 bg-gray-50"></textarea></div>
                            <div class="md:col-span-2"><label class="text-sm font-bold text-gray-600">স্ক্র্যাচ নিয়ম</label><textarea id="inst-scratch" rows="2" class="w-full p-2 border rounded mt-1 bg-gray-50"></textarea></div>
                        </div>
                        <button onclick="saveInstructions()" class="mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg font-bold">সেভ করুন</button>
                    </div>

                    <!-- Daily Limits -->
                    <div class="bg-white p-6 rounded-2xl shadow-sm border">
                        <h3 class="text-xl font-bold mb-4 border-b pb-2">ডেইলি লিমিট (0 = বন্ধ)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div><label class="text-sm font-bold text-gray-600">ভিডিও অ্যাড</label><input type="number" id="limit-video" class="w-full p-2 border rounded mt-1 bg-gray-50"></div>
                            <div><label class="text-sm font-bold text-gray-600">স্পিন</label><input type="number" id="limit-spin" class="w-full p-2 border rounded mt-1 bg-gray-50"></div>
                            <div><label class="text-sm font-bold text-gray-600">স্ক্র্যাচ</label><input type="number" id="limit-scratch" class="w-full p-2 border rounded mt-1 bg-gray-50"></div>
                        </div>
                        <button onclick="saveLimits()" class="mt-4 bg-green-600 text-white px-6 py-2 rounded-lg font-bold">সেভ করুন</button>
                    </div>

                    <!-- Social Tasks -->
                    <div class="bg-white p-6 rounded-2xl shadow-sm border">
                        <h3 class="text-xl font-bold mb-4 border-b pb-2">সোশ্যাল মিডিয়া টাস্ক</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4">
                            <input type="text" id="social-title" placeholder="টাইটেল" class="p-2 border rounded">
                            <input type="text" id="social-link" placeholder="লিংক" class="p-2 border rounded">
                            <input type="number" id="social-reward" placeholder="কয়েন" class="p-2 border rounded">
                            <select id="social-type" class="p-2 border rounded">
                                <option value="telegram">Telegram</option>
                                <option value="youtube">YouTube</option>
                                <option value="facebook">Facebook</option>
                            </select>
                        </div>
                        <button onclick="addSocialTask()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold mb-6">যোগ করুন</button>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse"><thead class="bg-gray-100"><tr><th class="p-3">টাইটেল</th><th class="p-3">লিংক</th><th class="p-3">কয়েন</th><th class="p-3">অ্যাকশন</th></tr></thead><tbody id="social-task-list"></tbody></table>
                        </div>
                    </div>
                </div>

                <!-- Settings & Payment Methods -->
                <div id="settings-section" class="section hidden max-w-4xl mx-auto space-y-6">
                    <!-- General Settings -->
                    <div class="bg-white p-8 rounded-2xl shadow-sm border">
                        <h3 class="text-xl font-bold mb-4 border-b pb-2">জেনারেল সেটিংস</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="font-bold text-gray-700">ডেইলি বোনাস (কয়েন)</label><input type="number" id="daily-bonus" class="w-full p-3 border rounded-lg mt-1 bg-gray-50"></div>
                            <div><label class="font-bold text-gray-700">মিনিমাম উত্তোলন (টাকা)</label><input type="number" id="min-withdraw" class="w-full p-3 border rounded-lg mt-1 bg-gray-50"></div>
                            <div><label class="font-bold text-gray-700">অ্যাডমিন কন্টাক্ট লিংক</label><input type="text" id="admin-contact" class="w-full p-3 border rounded-lg mt-1 bg-gray-50"></div>
                            <div><label class="font-bold text-gray-700">App Logo URL</label><input type="text" id="app-logo-url" placeholder="https://..." class="w-full p-3 border rounded-lg mt-1 bg-gray-50"></div>
                        </div>
                        <button onclick="saveGeneralSettings()" class="w-full bg-slate-900 text-white font-bold py-3 rounded-lg mt-4">আপডেট করুন</button>
                    </div>

                    <!-- Payment Methods Management -->
                    <div class="bg-white p-8 rounded-2xl shadow-sm border">
                        <h3 class="text-xl font-bold mb-4 border-b pb-2">পেমেন্ট মেথড (লোগো সহ)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                            <input type="text" id="pay-name" placeholder="নাম (যেমন: Bkash)" class="p-3 border rounded-lg bg-gray-50">
                            <input type="text" id="pay-logo" placeholder="Logo URL (https://...)" class="p-3 border rounded-lg bg-gray-50">
                            <button onclick="addPaymentMethod()" class="bg-purple-600 text-white font-bold py-3 rounded-lg hover:bg-purple-700">মেথড যোগ করুন</button>
                        </div>
                        <div class="text-xs text-gray-500 mb-4">* লোগো হিসেবে ইমেজের ডাইরেক্ট লিংক ব্যবহার করুন।</div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-gray-100"><tr><th class="p-3">নাম</th><th class="p-3">লোগো</th><th class="p-3">অ্যাকশন</th></tr></thead>
                                <tbody id="payment-methods-list"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Withdrawals -->
                <div id="withdrawals-section" class="section hidden">
                    <div class="bg-white rounded-xl shadow-md overflow-hidden">
                        <div class="p-5 border-b bg-gray-50"><h3 class="font-bold">পেমেন্ট রিকোয়েস্ট</h3></div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left"><thead class="bg-gray-100"><tr><th class="p-4">ইউজার</th><th class="p-4">মেথড</th><th class="p-4">নাম্বার</th><th class="p-4">টাকা</th><th class="p-4">অ্যাকশন</th></tr></thead><tbody id="withdrawal-table-body"></tbody></table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script type="module">
        const firebaseConfig = {
          apiKey: "AIzaSyDw0dG76LvkhW0-qKLxWDyTAdMcGAuFmjM",
          authDomain: "game-store-38027.firebaseapp.com",
          databaseURL: "https://game-store-38027-default-rtdb.firebaseio.com",
          projectId: "game-store-38027",
          storageBucket: "game-store-38027.firebasestorage.app",
          messagingSenderId: "782890454632",
          appId: "1:782890454632:web:77b99bd27c88e8162975dd"
        };
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion, collection, onSnapshot, query, where, addDoc, serverTimestamp, increment, limit } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Auth
        window.adminLogin = async () => {
            try { await signInWithEmailAndPassword(auth, document.getElementById('admin-email').value, document.getElementById('admin-pass').value); } 
            catch(e) { Swal.fire('Error', 'ভুল তথ্য', 'error'); }
        };
        window.adminLogout = () => signOut(auth).then(()=> location.reload());
        onAuthStateChanged(auth, (user) => {
            if(user) {
                document.getElementById('admin-login-overlay').classList.add('hidden');
                document.getElementById('admin-wrapper').classList.remove('hidden');
                loadConfig(); initListeners();
            } else {
                document.getElementById('admin-login-overlay').classList.remove('hidden');
                document.getElementById('admin-wrapper').classList.add('hidden');
            }
        });

        window.toggleSidebar = () => { document.getElementById('sidebar').classList.toggle('sidebar-closed'); };
        window.showSection = (id, btn) => {
            document.querySelectorAll('.section').forEach(el => el.classList.add('hidden'));
            document.getElementById(id + '-section').classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(el => { el.classList.remove('sidebar-active', 'text-white'); el.classList.add('text-slate-400'); });
            btn.classList.add('sidebar-active', 'text-white'); btn.classList.remove('text-slate-400');
        };

        // Data
        async function loadConfig() {
            const snap = await getDoc(doc(db, "config", "main"));
            if (snap.exists()) {
                const data = snap.data();
                document.getElementById('limit-video').value = data.limits?.video || 0;
                document.getElementById('limit-spin').value = data.limits?.spin || 0;
                document.getElementById('limit-scratch').value = data.limits?.scratch || 0;
                document.getElementById('min-withdraw').value = data.minWithdraw || 50;
                document.getElementById('daily-bonus').value = data.dailyBonus || 100;
                document.getElementById('admin-contact').value = data.contactLink || '';
                document.getElementById('app-logo-url').value = data.logoUrl || ''; 
                
                const instructions = data.instructions || {};
                document.getElementById('inst-social').value = instructions.social || '';
                document.getElementById('inst-withdraw').value = instructions.withdraw || '';
                document.getElementById('inst-video').value = instructions.video || '';
                document.getElementById('inst-spin').value = instructions.spin || '';
                document.getElementById('inst-scratch').value = instructions.scratch || '';

                renderSocialList(data.socialTasks || []);
                renderNoticeList(data.notices || []);
                renderPaymentMethods(data.paymentMethods || []);
            }
        }

        // --- PAYMENT METHODS LOGIC (UPDATED WITH LOGO) ---
        window.addPaymentMethod = async () => {
            const name = document.getElementById('pay-name').value;
            const logo = document.getElementById('pay-logo').value;
            if(!name || !logo) return Swal.fire('Error', 'নাম এবং লোগো লিংক দিন', 'warning');
            
            const newMethod = { id: Date.now().toString(), name, logo };
            await updateDoc(doc(db, "config", "main"), { paymentMethods: arrayUnion(newMethod) });
            
            document.getElementById('pay-name').value = '';
            document.getElementById('pay-logo').value = '';
            
            // Success Message Only (NO RELOAD)
            Swal.fire({
                title: 'Success',
                text: 'পেমেন্ট মেথড যোগ হয়েছে',
                icon: 'success',
                timer: 1500,
                showConfirmButton: false
            });
            loadConfig(); // Refresh data manually
        };

        window.deletePaymentMethod = async (id) => {
            const snap = await getDoc(doc(db, "config", "main"));
            const methods = snap.data().paymentMethods || [];
            const updated = methods.filter(m => m.id !== id);
            await updateDoc(doc(db, "config", "main"), { paymentMethods: updated });
            renderPaymentMethods(updated);
            Swal.fire('Deleted', 'ডিলিট হয়েছে', 'success');
        };

        function renderPaymentMethods(methods) {
            const tbody = document.getElementById('payment-methods-list');
            tbody.innerHTML = '';
            methods.forEach(m => {
                tbody.innerHTML += `
                    <tr class="border-b">
                        <td class="p-3 font-bold">${m.name}</td>
                        <td class="p-3"><img src="${m.logo}" class="w-10 h-10 object-contain border rounded p-1"></td>
                        <td class="p-3"><button onclick="deletePaymentMethod('${m.id}')" class="text-red-500"><i class="fa-solid fa-trash"></i></button></td>
                    </tr>
                `;
            });
        }
        // ------------------------------------

        // Instructions Save Function
        window.saveInstructions = async () => {
            const instructions = {
                social: document.getElementById('inst-social').value,
                withdraw: document.getElementById('inst-withdraw').value,
                video: document.getElementById('inst-video').value,
                spin: document.getElementById('inst-spin').value,
                scratch: document.getElementById('inst-scratch').value
            };
            await setDoc(doc(db, "config", "main"), { instructions }, { merge: true });
            Swal.fire('Success', 'নিয়মাবলী সেভ হয়েছে', 'success');
        };

        // Notices
        window.addNotice = async () => {
            const text = document.getElementById('notice-text').value;
            if(!text) return Swal.fire('Error', 'নোটিশ লিখুন', 'warning');
            const snap = await getDoc(doc(db, "config", "main"));
            const currentNotices = snap.data().notices || [];
            if(currentNotices.length > 0) return Swal.fire('Error', 'আগের নোটিশ ডিলিট না করা পর্যন্ত নতুন নোটিশ দেওয়া যাবে না', 'error');
            const newNotice = { id: Date.now().toString(), text };
            await updateDoc(doc(db, "config", "main"), { notices: arrayUnion(newNotice) });
            document.getElementById('notice-text').value = '';
            Swal.fire('Success', 'নোটিশ যোগ হয়েছে', 'success').then(()=> loadConfig());
        }
        window.deleteNotice = async (id) => {
            const snap = await getDoc(doc(db, "config", "main"));
            const notices = snap.data().notices || [];
            const updated = notices.filter(n => n.id !== id);
            await updateDoc(doc(db, "config", "main"), { notices: updated });
            renderNoticeList(updated);
            Swal.fire('Deleted', 'ডিলিট হয়েছে', 'success');
        }
        function renderNoticeList(notices) {
            const ul = document.getElementById('notice-list');
            ul.innerHTML = '';
            notices.forEach(n => {
                ul.innerHTML += `<li class="flex justify-between bg-gray-50 p-2 rounded border border-gray-200"><span>${n.text}</span><button onclick="deleteNotice('${n.id}')" class="text-red-500"><i class="fa-solid fa-trash"></i></button></li>`;
            });
        }

        // Social Tasks
        window.addSocialTask = async () => {
            const title = document.getElementById('social-title').value;
            const link = document.getElementById('social-link').value;
            const reward = parseInt(document.getElementById('social-reward').value);
            const type = document.getElementById('social-type').value;
            if(!title || !link || !reward) return Swal.fire('Error', 'তথ্য দিন', 'warning');
            const newTask = { id: Date.now().toString(), title, link, reward, type };
            await updateDoc(doc(db, "config", "main"), { socialTasks: arrayUnion(newTask) });
            Swal.fire('Added', 'টাস্ক যুক্ত হয়েছে।', 'success').then(()=> loadConfig());
        };
        window.deleteSocialTask = async (id) => {
            const snap = await getDoc(doc(db, "config", "main"));
            const tasks = snap.data().socialTasks || [];
            const updated = tasks.filter(t => t.id !== id);
            await updateDoc(doc(db, "config", "main"), { socialTasks: updated });
            renderSocialList(updated);
            Swal.fire('Deleted', 'ডিলিট হয়েছে', 'success');
        }
        function renderSocialList(tasks) {
            const tbody = document.getElementById('social-task-list');
            tbody.innerHTML = '';
            tasks.forEach(t => {
                tbody.innerHTML += `<tr class="border-b"><td class="p-3">${t.title} <span class="bg-gray-200 text-xs px-1 rounded uppercase">${t.type}</span></td><td class="p-3 text-blue-500 truncate max-w-xs">${t.link}</td><td class="p-3 font-bold text-green-600">${t.reward}</td><td class="p-3"><button onclick="deleteSocialTask('${t.id}')" class="text-red-500"><i class="fa-solid fa-trash"></i></button></td></tr>`;
            });
        }

        // Settings
        window.saveLimits = async () => {
            const limits = { video: parseInt(document.getElementById('limit-video').value), spin: parseInt(document.getElementById('limit-spin').value), scratch: parseInt(document.getElementById('limit-scratch').value) };
            await setDoc(doc(db, "config", "main"), { limits }, { merge: true });
            Swal.fire('Success', 'সেভ হয়েছে', 'success');
        };
        window.saveGeneralSettings = async () => {
            const minWithdraw = parseInt(document.getElementById('min-withdraw').value);
            const dailyBonus = parseInt(document.getElementById('daily-bonus').value);
            const contactLink = document.getElementById('admin-contact').value;
            const logoUrl = document.getElementById('app-logo-url').value;
            await setDoc(doc(db, "config", "main"), { minWithdraw, dailyBonus, contactLink, logoUrl }, { merge: true });
            Swal.fire('Success', 'আপডেট হয়েছে', 'success');
        };

        // Listeners
        function initListeners() {
            onSnapshot(collection(db, "users"), snap => {
                document.getElementById('stat-total-users').innerText = snap.size;
                const tbody = document.getElementById('users-table-body');
                tbody.innerHTML = '';
                snap.docs.slice(0, 50).forEach(d => {
                    const u = d.data();
                    tbody.innerHTML += `<tr><td class="p-4 font-bold">${u.name}</td><td class="p-4 text-gray-500">${u.email}</td><td class="p-4 font-mono">${u.referralCode}</td><td class="p-4 font-bold text-green-600">${u.balance}</td></tr>`;
                });
            });
            onSnapshot(query(collection(db, "withdrawals"), where("status", "==", "pending")), snap => {
                document.getElementById('stat-pending-withdraw').innerText = snap.size;
                const tbody = document.getElementById('withdrawal-table-body');
                tbody.innerHTML = snap.empty ? '<tr><td colspan="5" class="p-4 text-center text-gray-400">খালি</td></tr>' : '';
                snap.forEach(d => {
                    const w = d.data();
                    tbody.innerHTML += `<tr class="border-b hover:bg-gray-50"><td class="p-4">${w.userName}</td><td class="p-4"><span class="bg-blue-100 text-blue-800 px-2 rounded text-xs">${w.method}</span></td><td class="p-4 font-mono">${w.paymentDetail}</td><td class="p-4 font-bold">৳ ${w.amount}</td><td class="p-4 space-x-2"><button onclick="processPayment('${d.id}', 'approved')" class="bg-green-500 text-white px-2 py-1 rounded text-xs">Approve</button><button onclick="processPayment('${d.id}', 'rejected')" class="bg-red-500 text-white px-2 py-1 rounded text-xs">Reject</button></td></tr>`;
                });
            });
        }

        window.processPayment = async (id, status) => {
            Swal.fire({ title: 'নিশ্চিত?', showCancelButton: true, confirmButtonText: 'হ্যাঁ' }).then(async (result) => {
                if (result.isConfirmed) {
                    const ref = doc(db, "withdrawals", id);
                    if(status === 'rejected') {
                        const snap = await getDoc(ref);
                        const userRef = doc(db, "users", snap.data().userId);
                        await updateDoc(userRef, { balance: increment(snap.data().amount * 100) });
                    }
                    await updateDoc(ref, { status });
                    Swal.fire('Done', '', 'success');
                }
            });
        };
    </script>
</body>
</html>
